name: Validate Stadium Data

on:
  pull_request:
    paths:
      - 'src/data/sections/**'
      - 'src/data/obstructions/**'
      - 'src/types/stadium-complete.ts'
      - 'scripts/validate-stadium-data.ts'
  push:
    branches:
      - main
    paths:
      - 'src/data/sections/**'
      - 'src/data/obstructions/**'
      - 'src/types/stadium-complete.ts'
      - 'scripts/validate-stadium-data.ts'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Stadium Data Files
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type checking
        run: npm run type-check

      - name: Run stadium data validation
        run: npm run validate-stadium-data

      - name: Run validation unit tests
        run: npm test -- scripts/__tests__/validate-stadium-data.test.ts

      - name: Upload validation report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: |
            validation-report.txt
          retention-days: 7

  data-quality:
    name: Check Data Quality Metrics
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for row-level data coverage
        run: |
          echo "Checking row-level data coverage..."

          # Count MLB stadiums with row-level data
          MLB_WITH_ROWS=$(grep -r "rows:" src/data/sections/mlb/ | wc -l || echo "0")
          MLB_TOTAL=$(find src/data/sections/mlb/ -name "*.ts" ! -name "index.ts" | wc -l || echo "1")

          echo "MLB stadiums with row data: $MLB_WITH_ROWS / $MLB_TOTAL"

          # Calculate percentage
          COVERAGE=$(awk "BEGIN {printf \"%.0f\", ($MLB_WITH_ROWS/$MLB_TOTAL)*100}")
          echo "Row-level coverage: $COVERAGE%"

          # Set as job output for future use
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Check file sizes
        run: |
          echo "Checking for oversized data files..."

          # Find files larger than 200KB
          LARGE_FILES=$(find src/data -type f -size +200k || echo "")

          if [ -n "$LARGE_FILES" ]; then
            echo "Warning: Large files detected:"
            echo "$LARGE_FILES"
          else
            echo "All data files are appropriately sized."
          fi

      - name: Verify obstruction coverage
        run: |
          echo "Checking obstruction file coverage..."

          # Count section files
          SECTION_FILES=$(find src/data/sections -name "*.ts" ! -name "index.ts" | wc -l || echo "0")

          # Count obstruction files
          OBS_FILES=$(find src/data/obstructions -name "*.ts" ! -name "index.ts" | wc -l || echo "0")

          echo "Section files: $SECTION_FILES"
          echo "Obstruction files: $OBS_FILES"

          # Ideally, we should have obstructions for most stadiums
          if [ "$OBS_FILES" -lt $((SECTION_FILES / 2)) ]; then
            echo "⚠️  Warning: Low obstruction coverage. Consider adding more obstruction models."
          else
            echo "✓ Good obstruction coverage"
          fi
